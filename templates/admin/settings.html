{% extends "admin/base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - {{ config.site_title }}{% endblock %}

{% block admin_content %}
<div x-data="settingsManager()" class="space-y-6">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div>
        <h1 class="text-2xl font-bold text-white">ç³»ç»Ÿè®¾ç½®</h1>
        <p class="text-gray-400 mt-1">é…ç½®ç½‘ç«™åŸºæœ¬ä¿¡æ¯å’Œç®¡ç†å¯†ç </p>
    </div>
    
    <!-- ç½‘ç«™è®¾ç½® -->
    <div class="glass-card p-6">
        <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
            <span>ğŸŒ</span>
            <span>ç½‘ç«™è®¾ç½®</span>
        </h2>
        
        <form @submit.prevent="saveSettings()">
            <div class="space-y-4 max-w-lg">
                <div class="form-group">
                    <label class="form-label">ç½‘ç«™æ ‡é¢˜</label>
                    <input type="text" 
                           x-model="siteSettings.site_title" 
                           class="glass-input form-input"
                           placeholder="ç½‘ç«™æ ‡é¢˜">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç½‘ç«™æè¿°</label>
                    <textarea x-model="siteSettings.site_description" 
                              class="glass-input form-input h-24 resize-none"
                              placeholder="ç½‘ç«™æè¿°"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ¯é¡µæ˜¾ç¤ºæ•°é‡</label>
                    <input type="number" 
                           x-model.number="siteSettings.items_per_page" 
                           class="glass-input form-input"
                           min="4"
                           max="100"
                           placeholder="12">
                </div>
                
                <button type="submit" class="btn-gradient" :disabled="savingSettings">
                    <span x-show="!savingSettings">ä¿å­˜è®¾ç½®</span>
                    <span x-show="savingSettings">ä¿å­˜ä¸­...</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- ä¿®æ”¹å¯†ç  -->
    <div class="glass-card p-6">
        <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
            <span>ğŸ”</span>
            <span>ä¿®æ”¹å¯†ç </span>
        </h2>
        
        <form @submit.prevent="changePassword()">
            <div class="space-y-4 max-w-lg">
                <div class="form-group">
                    <label class="form-label">å½“å‰å¯†ç </label>
                    <input type="password" 
                           x-model="passwordForm.old_password" 
                           class="glass-input form-input"
                           placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ–°å¯†ç </label>
                    <input type="password" 
                           x-model="passwordForm.new_password" 
                           class="glass-input form-input"
                           placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘4ä½ï¼‰"
                           minlength="4"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" 
                           x-model="passwordForm.confirm_password" 
                           class="glass-input form-input"
                           placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                           required>
                </div>
                
                <button type="submit" class="btn-gradient" :disabled="changingPassword">
                    <span x-show="!changingPassword">ä¿®æ”¹å¯†ç </span>
                    <span x-show="changingPassword">ä¿®æ”¹ä¸­...</span>
                </button>
            </div>
        </form>
    </div>
    
    <!-- å…³äº -->
    <div class="glass-card p-6">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span>â„¹ï¸</span>
            <span>å…³äº</span>
        </h2>
        
        <div class="text-gray-400 space-y-2">
            <p>å¤¸å…‹ç½‘ç›˜èµ„æºåˆ†äº«ç½‘ç«™</p>
            <p>ç‰ˆæœ¬: 1.0.0</p>
            <p>æŠ€æœ¯æ ˆ: Flask + TailwindCSS + Alpine.js</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function settingsManager() {
    return {
        siteSettings: {
            site_title: '{{ config.site_title }}',
            site_description: '{{ config.site_description }}',
            items_per_page: {{ config.items_per_page }}
        },
        passwordForm: {
            old_password: '',
            new_password: '',
            confirm_password: ''
        },
        savingSettings: false,
        changingPassword: false,
        
        async saveSettings() {
            this.savingSettings = true;
            try {
                await apiRequest('/api/admin/settings', {
                    method: 'PUT',
                    body: JSON.stringify(this.siteSettings)
                });
                showToast('è®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
            } finally {
                this.savingSettings = false;
            }
        },
        
        async changePassword() {
            if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            if (this.passwordForm.new_password.length < 4) {
                showToast('æ–°å¯†ç é•¿åº¦è‡³å°‘4ä½', 'error');
                return;
            }
            
            this.changingPassword = true;
            try {
                await apiRequest('/api/admin/password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        old_password: this.passwordForm.old_password,
                        new_password: this.passwordForm.new_password
                    })
                });
                
                showToast('å¯†ç ä¿®æ”¹æˆåŠŸ');
                
                // æ¸…ç©ºè¡¨å•
                this.passwordForm = {
                    old_password: '',
                    new_password: '',
                    confirm_password: ''
                };
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
            } finally {
                this.changingPassword = false;
            }
        }
    };
}
</script>
{% endblock %}